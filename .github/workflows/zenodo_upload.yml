name: Weekly upload to Zenodo (from data-latest)

on:
  schedule:
    # Weekly Monday 03:30 UTC
    - cron: "30 3 * * 1"
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  zenodo-upload:
    runs-on: ubuntu-latest

    env:
      ZENODO_BASE_URL: https://zenodo.org
      ZENODO_TOKEN: ${{ secrets.ZENODO_TOKEN }}
      ZENODO_DEPOSITION_ID: ${{ secrets.ZENODO_DEPOSITION_ID }}
      ZENODO_COMMUNITY: ${{ secrets.ZENODO_COMMUNITY }}
      ZENODO_CREATOR_NAME: ${{ secrets.ZENODO_CREATOR_NAME }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Required by your community policy
      ZENODO_REQUIRED_GRANT_ID: "10.3030/101119635"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure tools exist (jq, curl)
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi
          command -v curl
          command -v gh
          jq --version
          gh --version
          curl --version | head -n 2

      - name: Download latest release assets (data-latest)
        shell: bash
        run: |
          set -euo pipefail

          echo "::group::Locate GitHub release 'data-latest'"
          gh release view data-latest --json tagName,name,createdAt,url,assets -q \
            '{tag:.tagName,name:.name,createdAt:.createdAt,url:.url,assets:[.assets[].name]}' | jq .
          echo "::endgroup::"

          mkdir -p artifacts

          echo "::group::Download assets (*_data.zip) from data-latest"
          gh release download data-latest --pattern "*_data.zip" --dir artifacts
          echo "::endgroup::"

          echo "::group::List downloaded files"
          ls -lah artifacts
          echo "::endgroup::"

          COUNT=$(ls -1 artifacts/*_data.zip 2>/dev/null | wc -l | tr -d ' ')
          if [ "$COUNT" -eq 0 ]; then
            echo "ERROR: No *_data.zip files were downloaded from release 'data-latest'."
            exit 1
          fi

      - name: Upload to Zenodo (robust logs + retries)
        shell: bash
        run: |
          set -euo pipefail

          require_env() {
            local name="$1"
            if [ -z "${!name:-}" ]; then
              echo "ERROR: Missing env var $name"
              exit 1
            fi
          }

          echo "::group::Validate required env"
          require_env ZENODO_BASE_URL
          require_env ZENODO_TOKEN
          require_env ZENODO_DEPOSITION_ID
          require_env ZENODO_COMMUNITY
          require_env ZENODO_CREATOR_NAME
          require_env ZENODO_REQUIRED_GRANT_ID

          if ! [[ "$ZENODO_DEPOSITION_ID" =~ ^[0-9]+$ ]]; then
            echo "ERROR: ZENODO_DEPOSITION_ID must be numeric, got: $ZENODO_DEPOSITION_ID"
            exit 1
          fi

          echo "ZENODO_BASE_URL=$ZENODO_BASE_URL"
          echo "ZENODO_DEPOSITION_ID=$ZENODO_DEPOSITION_ID"
          echo "ZENODO_COMMUNITY=$ZENODO_COMMUNITY"
          echo "ZENODO_CREATOR_NAME=$ZENODO_CREATOR_NAME"
          echo "ZENODO_REQUIRED_GRANT_ID=$ZENODO_REQUIRED_GRANT_ID"
          echo "::endgroup::"

          zenodo_api() {
            # usage: zenodo_api METHOD URL [JSON_DATA]
            local method="$1"; shift
            local url="$1"; shift
            local data="${1:-}"

            local body headers http_code curl_rc
            body="$(mktemp)"
            headers="$(mktemp)"

            set +e
            if [ -n "$data" ]; then
              http_code=$(curl -sS \
                --connect-timeout 20 --max-time 300 \
                --retry 5 --retry-all-errors --retry-delay 2 \
                -D "$headers" -o "$body" -w "%{http_code}" \
                -X "$method" \
                -H "Authorization: Bearer ${ZENODO_TOKEN}" \
                -H "Content-Type: application/json" \
                "$url" \
                --data-binary "$data")
              curl_rc=$?
            else
              http_code=$(curl -sS \
                --connect-timeout 20 --max-time 300 \
                --retry 5 --retry-all-errors --retry-delay 2 \
                -D "$headers" -o "$body" -w "%{http_code}" \
                -X "$method" \
                -H "Authorization: Bearer ${ZENODO_TOKEN}" \
                "$url")
              curl_rc=$?
            fi
            set -e

            if [ "$curl_rc" -ne 0 ] || ! [[ "${http_code:-}" =~ ^[0-9]{3}$ ]]; then
              echo "ERROR: curl failed calling Zenodo" >&2
              echo "  METHOD: $method" >&2
              echo "  URL:    $url" >&2
              echo "  curl_rc=$curl_rc http_code='${http_code:-<empty>}'" >&2
              echo "---- response headers ----" >&2
              cat "$headers" >&2 || true
              echo "---- response body ----" >&2
              cat "$body" >&2 || true
              exit 1
            fi

            if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
              echo "ERROR: Zenodo API returned non-2xx" >&2
              echo "  METHOD: $method" >&2
              echo "  URL:    $url" >&2
              echo "  HTTP:   $http_code" >&2
              echo "---- response headers ----" >&2
              cat "$headers" >&2 || true
              echo "---- response body ----" >&2
              cat "$body" >&2 || true
              exit 1
            fi

            cat "$body"
          }

          echo "::group::Read GitHub release info (for metadata)"
          RELEASE_JSON="$(gh release view data-latest --json tagName,url,createdAt,name)"
          echo "$RELEASE_JSON" | jq .
          RELEASE_URL="$(echo "$RELEASE_JSON" | jq -r '.url')"
          RELEASE_TAG="$(echo "$RELEASE_JSON" | jq -r '.tagName')"
          RELEASE_DATE="$(echo "$RELEASE_JSON" | jq -r '.createdAt')"
          echo "::endgroup::"

          echo "::group::Fetch base Zenodo deposition"
          BASE_URL="$ZENODO_BASE_URL/api/deposit/depositions/$ZENODO_DEPOSITION_ID"
          BASE_JSON="$(zenodo_api GET "$BASE_URL")"
          echo "$BASE_JSON" | jq '{id, state, submitted, title:.metadata.title, conceptdoi, doi, links}'
          BASE_SUBMITTED="$(echo "$BASE_JSON" | jq -r '.submitted // false')"
          echo "::endgroup::"

          echo "::group::Create new version draft"
          if [ "$BASE_SUBMITTED" != "true" ]; then
            echo "ERROR: Expected base deposition to be published (submitted=true), got submitted=$BASE_SUBMITTED"
            exit 1
          fi

          NEW_JSON="$(zenodo_api POST "$ZENODO_BASE_URL/api/deposit/depositions/$ZENODO_DEPOSITION_ID/actions/newversion")"
          echo "$NEW_JSON" | jq '{id, state, submitted, links}'
          TARGET_ID="$(echo "$NEW_JSON" | jq -r '.id')"

          if [ -z "$TARGET_ID" ] || [ "$TARGET_ID" = "null" ]; then
            echo "ERROR: newversion did not return an id"
            exit 1
          fi

          echo "New draft deposition id: $TARGET_ID"
          echo "::endgroup::"

          echo "::group::Get bucket URL"
          BUCKET="$(echo "$NEW_JSON" | jq -r '.links.bucket')"
          if [ -z "$BUCKET" ] || [ "$BUCKET" = "null" ]; then
            echo "Bucket missing in newversion response; refetching deposition..."
            TARGET_JSON="$(zenodo_api GET "$ZENODO_BASE_URL/api/deposit/depositions/$TARGET_ID")"
            BUCKET="$(echo "$TARGET_JSON" | jq -r '.links.bucket')"
          else
            TARGET_JSON="$NEW_JSON"
          fi

          if [ -z "$BUCKET" ] || [ "$BUCKET" = "null" ]; then
            echo "ERROR: Could not determine bucket URL"
            echo "$TARGET_JSON" | jq .
            exit 1
          fi

          echo "Bucket: $BUCKET"
          echo "::endgroup::"

          echo "::group::Delete existing files in draft"
          TARGET_JSON="$(zenodo_api GET "$ZENODO_BASE_URL/api/deposit/depositions/$TARGET_ID")"
          echo "$TARGET_JSON" | jq -r '.files[]? | "\(.id)  \(.filename)  \(.filesize) bytes"' || true

          FILE_IDS="$(echo "$TARGET_JSON" | jq -r '.files[]?.id' || true)"
          if [ -n "${FILE_IDS:-}" ]; then
            while read -r fid; do
              [ -n "$fid" ] || continue
              echo "Deleting file id=$fid ..."
              zenodo_api DELETE "$ZENODO_BASE_URL/api/deposit/depositions/$TARGET_ID/files/$fid" >/dev/null
            done <<< "$FILE_IDS"
          else
            echo "No files to delete."
          fi
          echo "::endgroup::"

          echo "::group::Upload files"
          for f in artifacts/*_data.zip; do
            [ -f "$f" ] || continue
            name="$(basename "$f")"
            size="$(stat -c%s "$f")"
            echo "Uploading: $name ($size bytes) -> $BUCKET/$name"

            body="$(mktemp)"
            headers="$(mktemp)"

            set +e
            http_code=$(curl -sS \
              --connect-timeout 20 --max-time 600 \
              --retry 5 --retry-all-errors --retry-delay 2 \
              -D "$headers" -o "$body" -w "%{http_code}" \
              -H "Authorization: Bearer ${ZENODO_TOKEN}" \
              --upload-file "$f" \
              "$BUCKET/$name")
            curl_rc=$?
            set -e

            if [ "$curl_rc" -ne 0 ] || ! [[ "${http_code:-}" =~ ^[0-9]{3}$ ]] || [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
              echo "ERROR: Upload failed for $name"
              echo "  curl_rc=$curl_rc http_code='${http_code:-<empty>}'"
              echo "---- response headers ----"; cat "$headers" || true
              echo "---- response body ----"; cat "$body" || true
              exit 1
            fi

            echo "Uploaded OK: $name (HTTP $http_code)"
          done
          echo "::endgroup::"

          echo "::group::Update metadata (preserve + enforce grant + force publication_date + fix dates)"
          TODAY_UTC="$(date -u +%Y-%m-%d)"
          PUBDATE="$TODAY_UTC"
          TITLE="Stablecoin DeFi Hourly Dataset (weekly snapshot) - ${TODAY_UTC}"

          DESC="$(cat <<EOF
          Weekly snapshot uploaded automatically from the GitHub rolling release \`${RELEASE_TAG}\`.

          Source release: ${RELEASE_URL}
          Release created at: ${RELEASE_DATE}

          Files included: AAVE, Uniswap, Curve, ETH blocks mapping (ZIP archives).
          EOF
          )"

          CURRENT_DRAFT="$(zenodo_api GET "$ZENODO_BASE_URL/api/deposit/depositions/$TARGET_ID")"

          NEW_METADATA_ONLY="$(echo "$CURRENT_DRAFT" | jq \
            --arg title "$TITLE" \
            --arg desc "$DESC" \
            --arg pubdate "$PUBDATE" \
            --arg community "$ZENODO_COMMUNITY" \
            --arg grant "$ZENODO_REQUIRED_GRANT_ID" \
            '
            .metadata
            | .title = $title
            | .description = $desc
            | .publication_date = $pubdate
            | .communities = ((.communities // []) | map(select(.identifier != $community)) + [{identifier: $community}])
            | .grants = ((.grants // []) | map(select(.id != $grant)) + [{id: $grant}])
            | .dates = (
                ((.dates // []) | map(select(.type != "collected")))
                + [{type:"collected", start:$pubdate, end:$pubdate}]
              )
            ')"

          METADATA_PAYLOAD="$(jq -n --argjson md "$NEW_METADATA_ONLY" '{metadata: $md}')"

          echo "Metadata payload (sanity check):"
          echo "$METADATA_PAYLOAD" | jq '{publication_date: .metadata.publication_date, dates: .metadata.dates, grants: .metadata.grants, communities: .metadata.communities}'

          UPDATED="$(zenodo_api PUT "$ZENODO_BASE_URL/api/deposit/depositions/$TARGET_ID" "$METADATA_PAYLOAD")"
          echo "Zenodo response after PUT:"
          echo "$UPDATED" | jq '{id, state, submitted, publication_date: .metadata.publication_date}'
          echo "::endgroup::"

          echo "::group::Pre-publish validation"
          CHECK="$(zenodo_api GET "$ZENODO_BASE_URL/api/deposit/depositions/$TARGET_ID")"
          echo "$CHECK" | jq '.metadata | {title, publication_date, dates, grants, communities}'
          PUBDATE_ON_ZENODO="$(echo "$CHECK" | jq -r '.metadata.publication_date // ""')"
          if [ -z "$PUBDATE_ON_ZENODO" ] || [ "$PUBDATE_ON_ZENODO" = "null" ]; then
            echo "ERROR: publication_date is still missing on Zenodo draft; refusing to publish."
            exit 1
          fi
          echo "::endgroup::"

          echo "::group::Publish"
          PUB="$(zenodo_api POST "$ZENODO_BASE_URL/api/deposit/depositions/$TARGET_ID/actions/publish")"
          echo "$PUB" | jq '{id, state, submitted, doi, conceptdoi, links}'
          echo "Published record page: $(echo "$PUB" | jq -r '.links.html // empty')"
          echo "::endgroup::"

      - name: Summary
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo "Workflow completed at: $(date -u)"
          echo "If it failed, inspect the grouped logs above; Zenodo error bodies are printed to STDERR."