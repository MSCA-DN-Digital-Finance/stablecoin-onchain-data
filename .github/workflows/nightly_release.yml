name: Nightly DeFi Data Update (Release)

on:
  schedule:
    - cron: "20 2 * * *"  # nightly at 02:20 UTC
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  update-and-release:
    runs-on: ubuntu-latest
    env:
      ZENODO_API: https://zenodo.org/api

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install pandas requests python-dotenv pyarrow tqdm

      - name: Set nightly tag
        run: |
          echo "TAG=data-$(date -u +%Y-%m-%d)" >> $GITHUB_ENV

      # 1) Download previous state from rolling release (if it exists)
      - name: Download latest dataset state (optional)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p data
          if gh release view data-latest >/dev/null 2>&1; then
            gh release download data-latest --pattern "*_data.zip" --dir data || true
            for z in data/*_data.zip; do
              [ -f "$z" ] || continue
              unzip -o "$z" -d .
            done
          else
            echo "No data-latest release found; starting from scratch."
          fi

      # 2) Run your updater
      - name: Run data collection
        env:
          GRAPH_API_KEY: ${{ secrets.GRAPH_API_KEY }}
        run: |
          python get_aave_hourly.py
          python update_blocks_to_time.py
          python update_crv_3pool.py
          python update_uniswap_metrics.py
          python update_hourly_liquidity.py

      # 3) Package output
      - name: Zip dataset
        run: |
          zip -r aave_data.zip data/AAVE
          zip -r uniswap_data.zip data/Uniswap
          zip -r curve_data.zip data/Curve
          zip -r eth_blocks_data.zip data/ETH_blocks

      # 4) Publish a nightly snapshot release (archival)
      - name: Create nightly release + upload
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "$TAG" \
            --title "DeFi hourly datasets $TAG" \
            --notes "Automated nightly snapshot" \
            aave_data.zip uniswap_data.zip curve_data.zip eth_blocks_data.zip

      # 4b) Upload same files to Zenodo as a NEW VERSION (keeps concept DOI stable)
      - name: Zenodo - create new version draft
        env:
          ZENODO_TOKEN: ${{ secrets.ZENODO_TOKEN }}
          ZENODO_DEPOSITION_ID: ${{ secrets.ZENODO_DEPOSITION_ID }}
        run: |
          set -euo pipefail

          resp="$(curl -sS -X POST \
            "$ZENODO_API/deposit/depositions/$ZENODO_DEPOSITION_ID/actions/newversion" \
            -H "Authorization: Bearer $ZENODO_TOKEN")"

          latest_draft_url="$(echo "$resp" | jq -r '.links.latest_draft')"
          draft="$(curl -sS -H "Authorization: Bearer $ZENODO_TOKEN" "$latest_draft_url")"

          echo "ZENODO_DRAFT_ID=$(echo "$draft" | jq -r '.id')" >> $GITHUB_ENV
          echo "ZENODO_BUCKET=$(echo "$draft" | jq -r '.links.bucket')" >> $GITHUB_ENV

      - name: Zenodo - clear draft files (safety)
        env:
          ZENODO_TOKEN: ${{ secrets.ZENODO_TOKEN }}
        run: |
          set -euo pipefail
          files="$(curl -sS -H "Authorization: Bearer $ZENODO_TOKEN" \
            "$ZENODO_API/deposit/depositions/$ZENODO_DRAFT_ID" | jq -r '.files[]?.id')"

          for fid in $files; do
            curl -sS -X DELETE \
              -H "Authorization: Bearer $ZENODO_TOKEN" \
              "$ZENODO_API/deposit/depositions/$ZENODO_DRAFT_ID/files/$fid" >/dev/null
          done

      - name: Zenodo - upload ZIPs
        env:
          ZENODO_TOKEN: ${{ secrets.ZENODO_TOKEN }}
        run: |
          set -euo pipefail
          for f in aave_data.zip uniswap_data.zip curve_data.zip eth_blocks_data.zip; do
            curl -sS --fail \
              -H "Authorization: Bearer $ZENODO_TOKEN" \
              --upload-file "$f" \
              "$ZENODO_BUCKET/$(basename "$f")" >/dev/null
          done

      - name: Zenodo - update metadata + publish
        env:
          ZENODO_TOKEN: ${{ secrets.ZENODO_TOKEN }}
          ZENODO_CREATOR_NAME: ${{ secrets.ZENODO_CREATOR_NAME }}
          ZENODO_COMMUNITY: ${{ secrets.ZENODO_COMMUNITY }}
        run: |
          set -euo pipefail

          RELEASE_URL="${{ github.server_url }}/${{ github.repository }}/releases/tag/$TAG"
          DESC="Automated nightly snapshot from GitHub release: <a href=\"$RELEASE_URL\">$RELEASE_URL</a>"

          # Build metadata; include community only if provided
          if [ -n "${ZENODO_COMMUNITY:-}" ]; then
            jq -n \
              --arg title "DeFi hourly datasets ($TAG)" \
              --arg desc "$DESC" \
              --arg version "$TAG" \
              --arg creator "$ZENODO_CREATOR_NAME" \
              --arg comm "$ZENODO_COMMUNITY" \
              '{
                metadata: {
                  upload_type: "dataset",
                  title: $title,
                  description: $desc,
                  version: $version,
                  creators: [{name: $creator}],
                  communities: [{identifier: $comm}],
                  related_identifiers: [{
                    relation: "isSupplementTo",
                    identifier: "'"$RELEASE_URL"'",
                    scheme: "url"
                  }]
                }
              }' > meta.json
          else
            jq -n \
              --arg title "DeFi hourly datasets ($TAG)" \
              --arg desc "$DESC" \
              --arg version "$TAG" \
              --arg creator "$ZENODO_CREATOR_NAME" \
              '{
                metadata: {
                  upload_type: "dataset",
                  title: $title,
                  description: $desc,
                  version: $version,
                  creators: [{name: $creator}],
                  related_identifiers: [{
                    relation: "isSupplementTo",
                    identifier: "'"$RELEASE_URL"'",
                    scheme: "url"
                  }]
                }
              }' > meta.json
          fi

          curl -sS --fail -X PUT \
            -H "Authorization: Bearer $ZENODO_TOKEN" \
            -H "Content-Type: application/json" \
            --data-binary @meta.json \
            "$ZENODO_API/deposit/depositions/$ZENODO_DRAFT_ID" >/dev/null

          curl -sS --fail -X POST \
            -H "Authorization: Bearer $ZENODO_TOKEN" \
            "$ZENODO_API/deposit/depositions/$ZENODO_DRAFT_ID/actions/publish" >/dev/null

      # 5) Update rolling state release (so next run can download it)
      - name: Update rolling data-latest release asset
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release view data-latest >/dev/null 2>&1 || \
            gh release create data-latest --title "Latest DeFi dataset" --notes "Rolling state"

          for f in aave_data.zip uniswap_data.zip curve_data.zip eth_blocks_data.zip; do
            ASSET_ID=$(gh api repos/${{ github.repository }}/releases/tags/data-latest \
              --jq ".assets[] | select(.name==\"$f\") | .id" || true)
            if [ -n "$ASSET_ID" ]; then
              gh api -X DELETE repos/${{ github.repository }}/releases/assets/$ASSET_ID
            fi
            gh release upload data-latest "$f"
          done